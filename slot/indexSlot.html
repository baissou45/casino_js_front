<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/css/slot.css" />
    <title>Machine √† sous</title>

</head>

<body>
    <nav>
        <ul>
            <li onclick="openHelpModal()">Comment jouer?</li>
            <li onclick="openRulesModal()">Gains possibles</li>
            <li onclick="logout()"><a href="/index.html">Quitter</a></li>
        </ul>
    </nav>

    <!-- Interface pour la machine √† sous -->
    <div id="machine">
        <div id="imgSlot"></div>
        <!-- Formulaire de connexion -->
        <div id="loginForm" class="hide">
            <label for="username">Pseudo </label>
            <input type="text" id="username" placeholder="Entrez votre pseudo">
            <button id="boutonCon" onclick="authenticateUser()">Se connecter</button>
            <!-- Ajout d'un √©l√©ment pour afficher les erreurs -->
            <p id="errorMessage" style="color: red;"></p>
        </div>

        <!-- Interface de la machine √† sous -->
        <div id="slotMachine" style="display: none;">
            <h1 class="title">MACHINE A SOUS</h1>

            <div class="bet">
                <div id="cagnote">
                    <label for="balance">Cagnotte: </label>
                    <input type="text" id="balance" value="1000" readonly>
                    <span> ‚Ç¨</span>
                </div>
                <div id="mise">
                    <input type="text" id="bet" value="0">
                    <span> ‚Ç¨</span>
                </div>
                <div id="nbrVictoire">
                    <input type="text" id="nbrWin" value="0" readonly>
                </div>
            </div>

            <div class="slot">
                <div class="slots" id="slots1">
                    <span class="reel" id="reel1">üçí</span>
                    <span class="reel" id="reel2">üçã</span>
                    <span class="reel" id="reel3">üçä</span>
                </div>
                <div class="slots" id="slots2">
                    <span class="reel" id="reel4">üîî</span>
                    <span class="reel" id="reel5">üçâ</span>
                    <span class="reel" id="reel6">üçá</span>
                </div>
                <div class="slots" id="slots3">
                    <span class="reel" id="reel7">üîî</span>
                    <span class="reel" id="reel8">üí∞</span>
                    <span class="reel" id="reel9">7Ô∏è‚É£</span>
                </div>
            </div>

            <div id="imgSlot"></div>

            <div>
                <button id="boutonLancement" type="button" onclick="startSlotMachine()"></button>
            </div>

            <div>
                <button id="btnLance" type="button" onclick="startSlotMachine()">Lancer la machine</button>
            </div>

            <!-- Bo√Æte modale pour afficher les r√®gles -->
            <div id="rules" class="modal">
                <div class="modal-content">
                    <button class="close-btn" onclick="closeRulesModal()">&times;</button>
                    <h2>Gains possible</h2>
                    <p>Voici les gains possibles pour chaque symbole:</p>
                    <ul style="list-style-type: none; text-align: justify;">
                        <li>üçí: 7x la mise</li>
                        <li>üçã: 7x la mise</li>
                        <li>üçä: 7x la mise</li>
                        <li>üçâ: 15x la mise</li>
                        <li>üçá: 15x la mise</li>
                        <li>üîî: 40x la mise</li>
                        <li>üí∞: 20x la mise</li>
                        <li>7Ô∏è‚É£: 60x la mise</li>
                    </ul>
                </div>
            </div>

            <div id="help" class="modal">
                <div class="modal-content">
                    <button class="close-btn" onclick="closeHelpModal()">&times;</button>
                    <h2>Comment jouer</h2>
                    <ul>
                        <li>Entrez votre pseudo dans le champ pr√©vu √† cet effet</li>
                        <li>Appuyez sur le bouton "Se connecter" pour acc√©der √† la machine √† sous</li>
                        <li>Entrez la mise souhait√©e en prenant le soin d'entrer un montant valide</li>
                        <li>Appuyez sur le bouton "Lancer" ou sur le bouton rouge √† droite de la machine pour lancer un
                            tour</li>
                        <li>Alignez 3 symboles identiques sur une ligne horizontale ou diagonale pour gagner</li>
                        <li>Les gains sont calcul√©s en fonction de la mise et du nombre de combinaisons align√©e</li>
                        <li>Les gains sont ajout√©s √† la cagnotte si vous gagnez et les pertes sont d√©duites de la
                            cagnotte
                            si vous perdez</li>
                        <li>La cagnotte est affich√©e sur la machine et vous pouvez voir le nombre de tours gagn√©s</li>
                        <li>Relancez la machine si vous souhaitez continuer</li>
                    </ul>
                </div>
            </div>

            <!-- Bo√Æte modale pour afficher les messages -->
            <div id="messageModal" class="modal">
                <div class="modal-content">
                    <h2 id="messageText"></h2>
                </div>
            </div>
        </div>

        <!-- <div class="sidebar-left">
            <div id="statistics" class="debug"></div>
        </div>

        <div class="sidebar-left">
            <h2>Historique</h2>
            <div id="history" class="debug"></div>
        </div> -->
    </div>

    <script>
        // Fonction pour v√©rifier si l'utilisateur est d√©j√† authentifi√©
        function checkAuthentication() {
            const username = getCookie('username');
            if (username) {
                // Utilisateur d√©j√† authentifi√©, afficher la machine √† sous
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('slotMachine').style.display = 'block';

                // Cacher les autres div de #machine
                const machineDivs = document.querySelectorAll('#machine > div');
                machineDivs.forEach(div => {
                    if (div.id !== 'slotMachine') {
                        div.style.display = 'none';
                    }
                });
                // Afficher la barre de navigation
                showNavbar();
            } else {
                // Utilisateur non authentifi√©, afficher le formulaire de connexion
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('slotMachine').style.display = 'none';
                const machineDivs = document.querySelectorAll('#machine > div');
                machineDivs.forEach(div => {
                    if (div.id !== 'loginForm') {
                        div.style.display = 'none';
                    }
                });
                hideNavbar();
            }

        }

        // Fonction pour authentifier l'utilisateur
        function authenticateUser() {
            const username = document.getElementById('username').value;

            if (username.trim() !== '') {
                // Initialiser les donn√©es utilisateur
                const user = {
                    username: username,
                    balance: 1000, // Initialiser la cagnotte √† 1000‚Ç¨ (ou la valeur souhait√©e)
                    betHistory: [] // Initialiser l'historique des paris √† vide
                };

                // Stocker les donn√©es utilisateur dans le cookie
                setCookie('user', JSON.stringify(user), 1); // Cookie expirant dans 1 jour

                // Masquer le formulaire de connexion et afficher la machine √† sous
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('slotMachine').style.display = 'block';
                showNavbar();
                welcomeUser();
            } else {
                // Afficher un message d'erreur si le champ est vide
                document.getElementById('errorMessage').innerText = "Veuillez entrer un pseudo valide.";
            }
        }

        // Appel √† la fonction de v√©rification de l'authentification lors du chargement de la page
        window.onload = checkAuthentication;


        // Appel √† la fonction de v√©rification de l'authentification lors du rechargement de la page
        window.onpageshow = checkAuthentication;

        function logout() {
            // Supprimer tous les cookies
            document.cookie.split(";").forEach(function (c) {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            });

        }

        // Fonction pour masquer la barre de navigation
        function hideNavbar() {
            const navbar = document.querySelector('nav');
            navbar.style.display = 'none';
        }

        // Fonction pour afficher la barre de navigation
        function showNavbar() {
            const navbar = document.querySelector('nav');
            navbar.style.display = 'flex';
        }

        // Variables globales
        const symbols = ['üçí', 'üçã', 'üçä', 'üçâ', 'üçá', 'üîî', 'üí∞', '7Ô∏è‚É£'];
        const paytable = {
            '7Ô∏è‚É£': 60,
            'üîî': 40,
            'üí∞': 20,
            'üçâ': 15,
            'üçá': 15,
            'üçä': 7,
            'üçã': 7,
            'üçí': 7
        };

        // Fonction pour d√©marrer la machine √† sous
        function startSlotMachine() {
            const bet = parseInt(document.getElementById('bet').value);
            let balance = parseInt(document.getElementById('balance').value);

            if (bet > balance) {
                showMessage("Vous n'avez pas assez d'argent pour cette mise.");
                return;
            }

            if (bet > 500 || bet < 10) {
                showMessage("La mise doit √™tre compris entre 10 et 500.");
                return;
            }

            //si la mise saisie n'est pas un nombre renvoyer un message
            if (isNaN(bet)) {
                showMessage("Veuillez entrer un montant valide.");
                return;
            }

            // Soustraire la mise de la cagnotte
            balance -= bet;
            document.getElementById('balance').value = balance;

            // D√©marrer l'animation pour chaque symbole
            document.querySelectorAll('.reel').forEach((reel, index) => {
                const delay = index % 3 * 800; // D√©calage de 0,8s pour chaque ensemble de 3 rouleaux
                setTimeout(() => {
                    reel.style.animationName = 'moveDown';
                    reel.style.animationDuration = '2s';
                    reel.style.animationTimingFunction = 'ease-in-out';
                    reel.style.animationIterationCount = 'infinite';
                    reel.style.animationDirection = 'alternate';
                }, delay);
            });

            // D√©marrer la rotation de tous les symboles
            const intervalIds = [];
            document.querySelectorAll('.reel').forEach((reel, index) => {
                const delay = index % 3 * 800; // D√©calage de 0,8s pour chaque ensemble de 3 rouleaux
                const intervalId = setInterval(() => {
                    const randomIndex = Math.floor(Math.random() * symbols.length);
                    reel.innerText = symbols[randomIndex];
                }, 100); // Changer le symbole toutes les 100ms
                setTimeout(() => clearInterval(intervalId), 2000 + delay); // Arr√™ter apr√®s 2 secondes + d√©calage
                intervalIds.push(intervalId);
            });

            // G√©n√©rer les symboles finaux et v√©rifier les gains
            setTimeout(() => {
                const reels = document.querySelectorAll('.reel');
                const finalSymbols = Array.from(reels).map(reel => reel.innerText);
                const win = checkWin(finalSymbols, bet);
                updateUserData(bet, win); // Mettre √† jour les donn√©es utilisateur apr√®s chaque lancer

            }, 5000); // Attendre 5 secondes pour s'assurer que les rouleaux sont arr√™t√©s
        }

        // Fonction pour fermer le modal des r√®gles
        function closeRulesModal() {
            const rulesModal = document.getElementById('rules');
            rulesModal.style.display = 'none';
        }

        // Fonction pour ouvrir le modal des r√®gles
        function openRulesModal() {
            const rulesModal = document.getElementById('rules');
            rulesModal.style.display = 'block';
        }

        //Fonction pour ouvrir le modal "comment jouer"
        function openHelpModal() {
            const helpModal = document.getElementById('help');
            helpModal.style.display = 'block';
        }

        // Fonction pour fermer le modal "comment jouer"
        function closeHelpModal() {
            const helpModal = document.getElementById('help');
            helpModal.style.display = 'none';
        }

        // Fonction pour v√©rifier les gains
        function checkWin(reels, bet) {
            const lines = [
                // Lignes horizontales
                [0, 1, 2],
                [3, 4, 5],
                [6, 7, 8],
                // Lignes diagonales
                [0, 4, 8],
                [2, 4, 6]
            ];

            let totalWin = 0;

            // Parcourir chaque ligne pour v√©rifier les gains
            lines.forEach(line => {
                const symbolsOnLine = line.map(index => reels[index]);
                const uniqueSymbols = [...new Set(symbolsOnLine)];

                if (uniqueSymbols.length === 1 && uniqueSymbols[0] !== ' ') {
                    const symbol = uniqueSymbols[0];
                    totalWin += paytable[symbol] * bet;

                    // Appliquer la classe "win" aux cases gagnantes
                    line.forEach(index => {
                        const reel = document.getElementById(`reel${index + 1}`);
                        reel.style.animationName = ''; // Arr√™ter l'animation avant d'ajouter la classe
                        reel.classList.add('win');
                    });
                }
            });

            if (totalWin > 0) {
                let balance = parseInt(document.getElementById('balance').value);
                let nbrVictoire = parseInt(document.getElementById('nbrWin').value);

                balance += totalWin;
                document.getElementById('balance').value = balance;
                nbrVictoire++;
                document.getElementById('nbrWin').value = nbrVictoire;
                showMessage(`ü§ë Vous avez gagn√© ${totalWin}‚Ç¨ !`);
            } else {
                showMessage(`üò• Vous avez perdu !`);
            }

            // Mettre √† jour les statistiques
            displayStatistics();

            // Enregistrer le pari dans l'historique
            const result = reels.map(reel => reel.innerText).join('-');
            const win = totalWin > 0;
            updateBetHistory(bet, result, win);
        }

        //fonction pour souhaiter la bienvenue √† l'utilisateur quand il s'authentifie
        function welcomeUser() {
            const user = JSON.parse(getCookie('user'));
            if (user) {
                showMessage(`Bienvenue ${user.username} !`);
            }
        }

        // Fonction pour mettre √† jour les donn√©es utilisateur apr√®s chaque lancer
        function updateUserData(bet, win) {
            // Ajouter la fonction getCookie()
            function getCookie(name) {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        return cookie.substring(name.length + 1);
                    }
                }
                return null;
            }

            // Ajouter la fonction setCookie()
            function setCookie(name, value, days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                const expires = "expires=" + date.toUTCString();
                document.cookie = name + "=" + value + ";" + expires + ";path=/";
            }

            let user = JSON.parse(getCookie('user'));
            if (user) {
                const balance = parseInt(document.getElementById('balance').value);
                const result = Array.from(document.querySelectorAll('.reel')).map(reel => reel.innerText).join('-');

                // Mettre √† jour l'historique des paris
                const betHistory = user.betHistory || [];
                betHistory.push({ bet, result, win });
                user.betHistory = betHistory;

                // Mettre √† jour le solde
                if (win) {
                    user.balance += bet * (paytable[result.split('-')[0]] || 0);
                } else {
                    user.balance -= bet;
                }

                // Enregistrer les donn√©es utilisateur mises √† jour dans le cookie
                setCookie('user', JSON.stringify(user), 1);

                // Rafra√Æchir l'affichage des statistiques
                displayStatistics(); // Mettre √† jour les statistiques apr√®s chaque pari
            }
        }

        // Fonction pour afficher les statistiques de l'utilisateur
        function displayStatistics() {
            const statisticsDiv = document.getElementById('statistics');
            statisticsDiv.innerHTML = '<h2>R√©capitulatif</h2></br>';
            const user = JSON.parse(getCookie('user'));
            if (user) {
                const betHistory = user.betHistory || [];
                let wins = 0;
                let losses = 0;
                let totalWon = 0;
                let totalLost = 0;
                let totalSpent = 0;

                // Calculs des statistiques
                for (const bet of betHistory) {
                    if (bet.win) {
                        wins++;
                        totalWon += bet.bet;
                    } else {
                        losses++;
                        totalLost += bet.bet;
                    }
                    totalSpent += bet.bet;
                }

                const totalGames = betHistory.length;
                const balance = user.balance;

                statisticsDiv.innerHTML += `<p><span> > Joueur: </span> ${user.username}</p></br>`;
                statisticsDiv.innerHTML += `<p><span> > Victoires: </span> ${wins}</p>`;
                statisticsDiv.innerHTML += `<p><span> > D√©faites: </span> ${losses}</p>`;
                statisticsDiv.innerHTML += `<p><span> > Nombre total de jeux: </span> ${totalGames}</p></br>`;
                statisticsDiv.innerHTML += `<p><span> > Gains: </span> ${totalWon}‚Ç¨</p>`;
                statisticsDiv.innerHTML += `<p><span> > Pertes: </span> ${totalLost}‚Ç¨</p>`;
                statisticsDiv.innerHTML += `<p><span> > Montant total: </span> ${totalSpent}‚Ç¨</p></br>`;
                statisticsDiv.innerHTML += `<p><span> > Solde actuel: </span> ${balance}‚Ç¨</p>`;
            } else {
                statisticsDiv.innerHTML = '<p>Aucune statistique disponible.</p>';
            }
        }



        // Fonction pour afficher les messages dans le modal
        function showMessage(message) {
            const messageText = document.getElementById('messageText');
            messageText.innerText = message;
            const messageModal = document.getElementById('messageModal');
            messageModal.style.display = 'block';
            setTimeout(() => {
                messageModal.style.display = 'none';
            }, 3000); // Cacher le modal apr√®s 3 secondes
        }

        // Fonction pour obtenir la valeur d'un cookie
        function getCookie(name) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [cookieName, cookieValue] = cookie.split('=');
                if (cookieName.trim() === name) {
                    return cookieValue;
                }
            }
            return null;
        }

        // Fonction pour d√©finir la valeur d'un cookie
        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        // Fonction pour mettre √† jour l'historique des paris
        function updateBetHistory(bet, result, win) {
            const user = JSON.parse(getCookie('user'));
            if (user) {
                const betHistory = user.betHistory || [];
                betHistory.push({ bet, result, win });
                setCookie('user', JSON.stringify({ ...user, betHistory }), 1);
            }
        }

    </script>

</body>

</html>